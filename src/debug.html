<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase è°ƒè¯•å·¥å…·</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md p-6">
        <h1 class="text-3xl font-bold text-center mb-6">ğŸ”§ Firebase è°ƒè¯•å·¥å…·</h1>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Firebase è¿æ¥çŠ¶æ€ -->
            <div class="p-4 bg-blue-50 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">ğŸ”— Firebase è¿æ¥çŠ¶æ€</h2>
                <div id="firebase-status" class="space-y-2">
                    <div>Firebase åº”ç”¨: <span id="firebase-app-status" class="font-mono">æ£€æŸ¥ä¸­...</span></div>
                    <div>Authentication: <span id="firebase-auth-status" class="font-mono">æ£€æŸ¥ä¸­...</span></div>
                    <div>Firestore: <span id="firebase-firestore-status" class="font-mono">æ£€æŸ¥ä¸­...</span></div>
                </div>
            </div>

            <!-- è®¤è¯æ–¹å¼æ£€æŸ¥ -->
            <div class="p-4 bg-yellow-50 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">ğŸ›¡ï¸ è®¤è¯æ–¹å¼çŠ¶æ€</h2>
                <div id="auth-methods-status" class="space-y-2">
                    <div>é‚®ç®±/å¯†ç è®¤è¯: <span id="email-auth-status" class="font-mono">æ£€æŸ¥ä¸­...</span></div>
                    <div>å½“å‰ç”¨æˆ·: <span id="current-user-status" class="font-mono">æ£€æŸ¥ä¸­...</span></div>
                </div>
            </div>

            <!-- æµ‹è¯•æ³¨å†Œ -->
            <div class="p-4 bg-green-50 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">ğŸ“ æµ‹è¯•æ³¨å†Œ</h2>
                <form id="test-signup-form" class="space-y-3">
                    <input type="email" id="test-email" placeholder="æµ‹è¯•é‚®ç®±" class="w-full p-2 border rounded" required>
                    <input type="password" id="test-password" placeholder="æµ‹è¯•å¯†ç " class="w-full p-2 border rounded" required>
                    <button type="submit" class="w-full bg-green-500 text-white p-2 rounded hover:bg-green-600">æµ‹è¯•æ³¨å†Œ</button>
                </form>
                <div id="signup-result" class="mt-3"></div>
            </div>

            <!-- é”™è¯¯æ—¥å¿— -->
            <div class="p-4 bg-red-50 rounded-lg">
                <h2 class="text-xl font-semibold mb-4">ğŸ“‹ é”™è¯¯æ—¥å¿—</h2>
                <div id="error-log" class="bg-gray-800 text-green-400 p-3 rounded font-mono text-sm h-40 overflow-y-auto">
                    ç­‰å¾…æ—¥å¿—...
                </div>
                <button id="clear-log" class="mt-2 px-3 py-1 bg-gray-500 text-white rounded text-sm">æ¸…é™¤æ—¥å¿—</button>
            </div>
        </div>

        <!-- Setup Guide -->
        <div class="mt-6 p-4 bg-indigo-50 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">ğŸ“š If you see "operation-not-allowed" error:</h2>
            <ol class="list-decimal list-inside space-y-2 text-sm">
                <li>Visit <a href="https://console.firebase.google.com/" target="_blank" class="text-blue-600 underline">Firebase Console</a></li>
                <li>Select your project: <code class="bg-gray-200 px-1 rounded">final-3cf98</code></li>
                <li>Click <strong>"Authentication"</strong> in the left sidebar</li>
                <li>Click <strong>"Sign-in method"</strong> tab</li>
                <li>Find <strong>"Email/Password"</strong> and click it</li>
                <li>Enable <strong>"Email/Password"</strong> option</li>
                <li>Click <strong>"Save"</strong></li>
                <li>Return to this page, refresh and test again</li>
            </ol>
        </div>
        
        <!-- Navigation Test -->
        <div class="mt-6 p-4 bg-purple-50 rounded-lg">
            <h2 class="text-xl font-semibold mb-4">ğŸ§­ Navigation Test</h2>
            <div class="space-x-2">
                <a href="index.html" class="inline-block px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">Home Page</a>
                <a href="flights.html" class="inline-block px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">Flights Page</a>
                <a href="pages/hotel_search.html" class="inline-block px-4 py-2 bg-purple-500 text-white rounded hover:bg-purple-600">Hotel Search</a>
            </div>
            <p class="text-sm text-gray-600 mt-2">Test user state management on different pages</p>
        </div>
    </div>

    <script type="module">
        import { auth, db } from "./scripts/firebase-config.js";
        import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
        import { doc, setDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logElement = document.getElementById('error-log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'text-red-400' : type === 'success' ? 'text-green-400' : 'text-blue-400';
            logElement.innerHTML += `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
        }

        // æ£€æŸ¥ Firebase çŠ¶æ€
        function checkFirebaseStatus() {
            try {
                // æ£€æŸ¥ Firebase åº”ç”¨
                if (auth.app) {
                    document.getElementById('firebase-app-status').textContent = 'âœ… å·²è¿æ¥';
                    document.getElementById('firebase-app-status').className = 'font-mono text-green-600';
                    log('Firebase åº”ç”¨åˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    document.getElementById('firebase-app-status').textContent = 'âŒ æœªè¿æ¥';
                    document.getElementById('firebase-app-status').className = 'font-mono text-red-600';
                }

                // æ£€æŸ¥ Auth
                if (auth) {
                    document.getElementById('firebase-auth-status').textContent = 'âœ… å·²åˆå§‹åŒ–';
                    document.getElementById('firebase-auth-status').className = 'font-mono text-green-600';
                    log('Firebase Auth åˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    document.getElementById('firebase-auth-status').textContent = 'âŒ æœªåˆå§‹åŒ–';
                    document.getElementById('firebase-auth-status').className = 'font-mono text-red-600';
                }

                // æ£€æŸ¥ Firestore
                if (db) {
                    document.getElementById('firebase-firestore-status').textContent = 'âœ… å·²åˆå§‹åŒ–';
                    document.getElementById('firebase-firestore-status').className = 'font-mono text-green-600';
                    log('Firestore åˆå§‹åŒ–æˆåŠŸ', 'success');
                } else {
                    document.getElementById('firebase-firestore-status').textContent = 'âŒ æœªåˆå§‹åŒ–';
                    document.getElementById('firebase-firestore-status').className = 'font-mono text-red-600';
                }

                // æ£€æŸ¥å½“å‰ç”¨æˆ·
                if (auth.currentUser) {
                    document.getElementById('current-user-status').textContent = `âœ… ${auth.currentUser.email}`;
                    document.getElementById('current-user-status').className = 'font-mono text-green-600';
                } else {
                    document.getElementById('current-user-status').textContent = 'âŒ æœªç™»å½•';
                    document.getElementById('current-user-status').className = 'font-mono text-gray-600';
                }

            } catch (error) {
                log(`Firebase çŠ¶æ€æ£€æŸ¥é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•æ³¨å†Œ
        document.getElementById('test-signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('test-email').value;
            const password = document.getElementById('test-password').value;
            const resultDiv = document.getElementById('signup-result');

            log(`å°è¯•æ³¨å†Œ: ${email}`, 'info');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                
                log(`æ³¨å†ŒæˆåŠŸ: ${user.email}`, 'success');
                resultDiv.innerHTML = `<div class="text-green-600">âœ… æ³¨å†ŒæˆåŠŸï¼ç”¨æˆ·ID: ${user.uid}</div>`;
                
                // æ›´æ–°çŠ¶æ€
                checkFirebaseStatus();
                
            } catch (error) {
                log(`æ³¨å†Œé”™è¯¯: ${error.code} - ${error.message}`, 'error');
                
                let errorMessage = 'æ³¨å†Œå¤±è´¥';
                switch (error.code) {
                    case 'auth/operation-not-allowed':
                        errorMessage = 'âŒ é‚®ç®±/å¯†ç è®¤è¯æœªå¯ç”¨ï¼è¯·æŒ‰ç…§ä¸‹é¢çš„æŒ‡å—åœ¨ Firebase æ§åˆ¶å°å¯ç”¨ã€‚';
                        document.getElementById('email-auth-status').textContent = 'âŒ æœªå¯ç”¨';
                        document.getElementById('email-auth-status').className = 'font-mono text-red-600';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'âš ï¸ è¯¥é‚®ç®±å·²è¢«æ³¨å†Œ';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'âš ï¸ å¯†ç å¼ºåº¦ä¸å¤Ÿ';
                        break;
                    default:
                        errorMessage = `âŒ ${error.message}`;
                }
                
                resultDiv.innerHTML = `<div class="text-red-600">${errorMessage}</div>`;
            }
        });

        // æ¸…é™¤æ—¥å¿—
        document.getElementById('clear-log').addEventListener('click', () => {
            document.getElementById('error-log').innerHTML = 'æ—¥å¿—å·²æ¸…é™¤...';
        });

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹æ£€æŸ¥ Firebase çŠ¶æ€', 'info');
            checkFirebaseStatus();
        });
    </script>
</body>
</html>
